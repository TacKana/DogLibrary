name: Build the release version

on:
  push:
    tags:
      - v*.*.*
      
jobs:
  release:
    name: 开始构建
    runs-on: ${{matrix.os}}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
        - name: 提取代码
          uses: actions/checkout@v5
        - name: 安装nodejs
          uses: actions/setup-node@v5
          with:
            node-version: 22
        - name: 安装依赖
          run: npm install
        - name: 构建linux
          env:
            SNAPCRAFT_STORE_CREDENTIALS: ${{secrets.SNAPCRAFT_STORE_CREDENTIALS}}
          if: matrix.os == 'ubuntu-latest'
          run:  |
            sudo snap install snapcraft --classic
            sudo apt-get update
            sudo apt-get install -y fakeroot
            npm run build:linux

        - name: 构建macos
          if: matrix.os == 'macos-latest'
          run: npm run build:mac

        - name: 构建windows
          if: matrix.os == 'windows-latest'
          run: npm run build:win
        - name: 上传构建产物
          uses: actions/upload-artifact@v4
          with:
            name: build-artifacts-${{ matrix.os }}
            path: |
              dist/**/*
              !dist/node_modules/
            retention-days: 7
    # 新增：单独的发布作业
  create-release:
    name: 创建发布
    runs-on: ubuntu-latest
    needs: release  # 依赖构建作业完成
    steps:
      - name: 下载所有构建产物
        uses: actions/download-artifact@v4
        with:
          path: dist-all/
          
      - name: 创建GitHub发布
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          files: |
            dist-all/**/*.exe
            dist-all/**/*.zip
            dist-all/**/*.dmg
            dist-all/**/*.AppImage
            dist-all/**/*.snap
            dist-all/**/*.deb
            dist-all/**/*.rpm
            dist-all/**/*.tar.gz
            dist-all/**/*.yml
            dist-all/**/*.blockmap
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # 建议使用内置token
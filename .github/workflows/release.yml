name: Build the release version

on:
  push:
    tags:
      - v*.*.*
# ğŸ”‘ å…³é”®ä¿®å¤ï¼šæ·»åŠ æƒé™é…ç½®
permissions:
  contents: write  # æˆäºˆåˆ›å»ºå‘å¸ƒçš„æƒé™
 
jobs:
  release:
    name: å¼€å§‹æ„å»º
    runs-on: ${{matrix.os}}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
        - name: æå–ä»£ç 
          uses: actions/checkout@v5
        - name: å®‰è£…nodejs
          uses: actions/setup-node@v5
          with:
            node-version: 22
        - name: å®‰è£…ä¾èµ–
          run: npm install
        - name: æ„å»ºlinux
          env:
            SNAPCRAFT_STORE_CREDENTIALS: ${{secrets.SNAPCRAFT_STORE_CREDENTIALS}}
          if: matrix.os == 'ubuntu-latest'
          run:  |
            sudo snap install snapcraft --classic
            sudo apt-get update
            sudo apt-get install -y fakeroot
            npm run build:linux

        - name: æ„å»ºmacos
          if: matrix.os == 'macos-latest'
          run: npm run build:mac

        - name: æ„å»ºwindows
          if: matrix.os == 'windows-latest'
          run: npm run build:win
        - name: ä¸Šä¼ æ„å»ºäº§ç‰©
          uses: actions/upload-artifact@v4
          with:
            name: build-artifacts-${{ matrix.os }}
            path: |
              dist/**/*
              !dist/node_modules/
            retention-days: 7
    # æ–°å¢ï¼šå•ç‹¬çš„å‘å¸ƒä½œä¸š
  create-release:     
    name: åˆ›å»ºå‘å¸ƒ
    runs-on: ubuntu-latest
    needs: release  # ä¾èµ–æ„å»ºä½œä¸šå®Œæˆ
    permissions:
      contents: write

    steps:
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: dist-all/
          
      - name: åˆ›å»ºGitHubå‘å¸ƒ
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          fail_on_unmatched_files: false
          replace: true
          files: |
            dist-all/**/*.exe
            dist-all/**/*.zip
            dist-all/**/*.dmg
            dist-all/**/*.AppImage
            dist-all/**/*.snap
            dist-all/**/*.deb
            dist-all/**/*.rpm
            dist-all/**/*.tar.gz
            dist-all/**/*.yml
            dist-all/**/*.blockmap
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # å»ºè®®ä½¿ç”¨å†…ç½®token
name: Build the release version

on:
  push:
    tags:
      - v*.*.*

# 添加全局权限
permissions:
  contents: write

jobs:
  release:
    name: 开始构建
    runs-on: ${{matrix.os}}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    
    # 或者在作业级别添加权限
    permissions:
      contents: write
      
    steps:
      - name: 提取代码
        uses: actions/checkout@v5
        
      - name: 安装nodejs
        uses: actions/setup-node@v5
        with:
          node-version: 22
          
      - name: 安装依赖
        run: npm install
        
      - name: 构建linux
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{secrets.SNAPCRAFT_STORE_CREDENTIALS}}
        if: matrix.os == 'ubuntu-latest'
        run:  |
          sudo snap install snapcraft --classic
          sudo apt-get update
          sudo apt-get install -y fakeroot
          npm run build:linux

      - name: 构建macos
        if: matrix.os == 'macos-latest'
        run: npm run build:mac

      - name: 构建windows
        if: matrix.os == 'windows-latest'
        run: npm run build:win
        
      - name: 列出生成的文件（调试用）
        run: find dist/ -type f || echo "未找到dist目录"
        
      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ matrix.os }}
          path: |
            dist/**/*
            !dist/node_modules/
          retention-days: 7

  create-release:
    name: 创建发布
    runs-on: ubuntu-latest
    needs: release
    
    # 确保发布作业有写入权限
    permissions:
      contents: write
      packages: write
      
    steps:
      - name: 下载所有构建产物
        uses: actions/download-artifact@v4
        with:
          path: dist-all/
          
      - name: 列出下载的文件（调试用）
        run: |
          echo "下载的文件结构："
          find dist-all/ -type f | head -20 || echo "未找到文件"
          echo "--- 详细结构 ---"
          ls -la dist-all/ || echo "dist-all目录不存在"
          echo "--- 各子目录 ---"
          find dist-all/ -mindepth 1 -type d | head -10
          
      - name: 创建GitHub发布
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          files: |
            dist-all/**/*.exe
            dist-all/**/*.zip
            dist-all/**/*.dmg
            dist-all/**/*.AppImage
            dist-all/**/*.snap
            dist-all/**/*.deb
            dist-all/**/*.rpm
            dist-all/**/*.tar.gz
            dist-all/**/*.yml
            dist-all/**/*.blockmap
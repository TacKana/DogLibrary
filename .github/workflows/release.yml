name: Build and Release

on:
  push:
    tags:
      - v*.*.*  # åªåœ¨æ‰“ tagï¼ˆv1.2.3ï¼‰æ—¶è§¦å‘

permissions:
  contents: write  # ç”¨äºåˆ›å»º Releaseã€ä¸Šä¼ æ–‡ä»¶ç­‰æ“ä½œ

jobs:
  build:
    name: æ„å»º ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v5

      # ğŸ§© ç¼“å­˜ npm ä¾èµ–ï¼ŒåŠ é€Ÿæ„å»º
      - name: ç¼“å­˜ npm ä¾èµ–
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: å®‰è£… Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 22
          cache: npm  # actions/setup-node å†…ç½® npm ç¼“å­˜æ”¯æŒï¼ˆé…åˆä¸Šé¢çš„ cache åŒä¿é™©ï¼‰

      - name: å®‰è£…ä¾èµ–
        run: npm ci  # æ¯” npm install æ›´å¯é ï¼ˆåŸºäº lock æ–‡ä»¶ï¼‰

      # ğŸ§± å„å¹³å°åˆ†åˆ«æ„å»º
      - name: æ„å»º Linux
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y snapcraft fakeroot
          npm run build:linux

      - name: æ„å»º macOS
        if: matrix.os == 'macos-latest'
        run: npm run build:mac

      - name: æ„å»º Windows
        if: matrix.os == 'windows-latest'
        run: npm run build:win

      # ğŸ“¦ ä¸Šä¼ æ¯ä¸ªå¹³å°çš„æ„å»ºç»“æœ
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.os }}
          path: |
            dist/**/*
            !dist/node_modules/
          retention-days: 7

  # ğŸš€ Release ä½œä¸šï¼šæ±‡æ€»æ„å»ºäº§ç‰©å¹¶åˆ›å»ºå‘å¸ƒ
  release:
    name: åˆ›å»º GitHub å‘å¸ƒ
    runs-on: ubuntu-latest
    needs: build  # ç­‰å¾…ä¸Šé¢æ‰€æœ‰å¹³å°æ„å»ºå®Œæˆ
    permissions:
      contents: write

    steps:
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: dist-all/

      # ğŸ§¾ è‡ªåŠ¨ç”Ÿæˆ Release è¯´æ˜ï¼ˆåŸºäºæäº¤è®°å½•ï¼‰
      - name: è‡ªåŠ¨ç”Ÿæˆ Release Notes
        id: notes
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          draft: true  # å…ˆç”Ÿæˆè‰ç¨¿ï¼Œæ–¹ä¾¿é¢„è§ˆ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ğŸª„ ä¸Šä¼  Release èµ„äº§å¹¶å‘å¸ƒ
      - name: å‘å¸ƒ Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          draft: false
          fail_on_unmatched_files: false
          files: |
            dist-all/**/*.exe
            dist-all/**/*.zip
            dist-all/**/*.dmg
            dist-all/**/*.AppImage
            dist-all/**/*.snap
            dist-all/**/*.deb
            dist-all/**/*.rpm
            dist-all/**/*.tar.gz
            dist-all/**/*.yml
            dist-all/**/*.blockmap
          body: ${{ steps.notes.outputs.body }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
